<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel Administrativo - Gatonautas</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      color: #222;
      margin: 0;
      padding: 20px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    h1, h2, h3 {
      color: #ff6f61;
    }
    button {
      background-color: #ff6f61;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 700;
      margin-top: 8px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #e65a50;
    }
    .logout-btn {
      float: right;
      margin-bottom: 20px;
      background-color: #555;
    }
    .logout-btn:hover {
      background-color: #333;
    }
    section {
      margin-bottom: 40px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .product-item, .contact-item {
      border-bottom: 1px solid #ddd;
      padding: 12px 0;
    }
    .product-item:last-child, .contact-item:last-child {
      border-bottom: none;
    }
    .product-actions {
      margin-top: 8px;
    }
    input, textarea {
      width: calc(100% - 24px); /* Ajuste para padding */
      padding: 8px 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
      resize: vertical;
      box-sizing: border-box; /* Para incluir padding e borda na largura total */
    }
    label {
      font-weight: 600;
      color: #ff6f61;
      display: block; /* Para garantir que o input fique abaixo */
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <button class="logout-btn" id="logoutBtn">Sair</button>
  <h1>Painel Administrativo</h1>

  <section>
    <h2>Produtos Cadastrados</h2>
    <div id="produtosLista">
      </div>

    <h3>Adicionar Novo Produto</h3>
    <form id="formAddProduto">
      <label for="name">Nome</label>
      <input type="text" id="name" required />
      
      <label for="description">Descrição</label>
      <textarea id="description" rows="2" required></textarea>
      
      <label for="price">Preço (ex: 29.90)</label>
      <input type="number" id="price" step="0.01" required />
      
      <label for="image">URL da Imagem</label>
      <input type="text" id="image" required />

      <button type="submit">Adicionar Produto</button>
    </form>
  </section>

  <section>
    <h2>Mensagens Recebidas</h2>
    <div id="contatosLista">
      </div>
  </section>

<script>
  const apiBase = 'https://gatonautas-backend.onrender.com'; // CORRIGIDO
  const token = localStorage.getItem('token'); // Este token é para o login de ADMIN

  // Se não tem token de admin, volta para login (admin login, não o login de usuário comum)
  // Assumindo que 'login.html' é a página de login do admin também.
  // Se for diferente, ajuste o redirecionamento.
  if (!token) {
    alert('Acesso restrito. Por favor, faça o login como administrador.');
    window.location.href = 'login.html'; // Ou a página de login específica do admin
  }

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('token'); // Remove o token de admin
    alert('Logout realizado com sucesso.');
    window.location.href = 'login.html'; // Ou a página de login específica do admin
  });

  // Função para carregar produtos
  async function carregarProdutos() {
    try {
      const res = await fetch(`${apiBase}/produtos`, { // A rota GET /produtos agora é pública
        // Para listar no admin, não precisa mais de token se GET /produtos for público.
        // Se você mantiver GET /produtos protegido SOMENTE para admin, descomente headers.
        // headers: { Authorization: `Bearer ${token}` } 
      });
      // Se GET /produtos for pública, o backend não retornará 401 por falta de token.
      // Mas, se houver outro erro de servidor, o !res.ok ainda é útil.
      if (!res.ok && res.status !== 401 && res.status !== 403) { // Ignora erros de token se GET é público
         const errorData = await res.json().catch(() => ({ message: 'Erro desconhecido ao carregar produtos.' }));
         throw new Error(errorData.message || `Erro HTTP: ${res.status}`);
      }
      // Se GET /produtos for público e der 401/403 por algum motivo inesperado (ex: CORS mal configurado no server),
      // o código abaixo ainda pode falhar. Mas a intenção é que seja público.

      const produtos = await res.json();
      const container = document.getElementById('produtosLista');
      container.innerHTML = '';
      
      if(produtos.length === 0){
        container.innerHTML = '<p>Nenhum produto cadastrado.</p>';
        return;
      }

      produtos.forEach(p => {
        const div = document.createElement('div');
        div.className = 'product-item';
        div.innerHTML = `
          <strong>${p.name}</strong> - R$ ${p.price ? p.price.toFixed(2) : 'N/A'}<br/>
          ${p.description || 'Sem descrição.'}<br/>
          <img src="${p.image}" alt="${p.name}" style="max-width:150px; border-radius:8px; margin-top:5px;" />
          <div class="product-actions">
            <button onclick="removerProduto(${p.id})">Remover</button>
          </div>
        `;
        container.appendChild(div);
      });
    } catch (error) {
      console.error('Erro ao carregar produtos:', error);
      // Não redirecionar para login.html aqui, pois GET /produtos deve ser público.
      // Apenas mostre uma mensagem de erro.
      document.getElementById('produtosLista').innerHTML = `<p style="color:red;">Erro ao carregar produtos: ${error.message}. Tente recarregar a página.</p>`;
    }
  }

  // Remover produto (requer token)
  async function removerProduto(id) {
    if (!confirm('Confirma remoção do produto?')) return;
    if (!token) { // Garante que há token para operações de escrita
        alert('Sessão expirada ou token inválido. Faça login novamente.');
        window.location.href = 'login.html'; // Ou página de login do admin
        return;
    }
    try {
      const res = await fetch(`${apiBase}/produtos/${id}`, { // O backend deve mapear :id para :productId ou vice-versa
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) {
        const errorData = await res.json().catch(() => ({ message: 'Erro desconhecido ao remover produto.' }));
        throw new Error(errorData.message || `Erro HTTP: ${res.status}`);
      }
      // alert('Produto removido com sucesso!'); // Opcional
      carregarProdutos(); // Recarrega a lista
    } catch (error) {
      console.error('Erro ao remover produto:', error);
      alert(`Erro ao remover produto: ${error.message}`);
      if (error.message.includes("Token inválido") || error.message.includes("Token não fornecido")) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
      }
    }
  }

  // Adicionar produto (requer token)
  document.getElementById('formAddProduto').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!token) { // Garante que há token para operações de escrita
        alert('Sessão expirada ou token inválido. Faça login novamente.');
        window.location.href = 'login.html'; // Ou página de login do admin
        return;
    }

    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const image = document.getElementById('image').value.trim();

    if (!name || !description || isNaN(price) || !image) {
      alert('Preencha todos los campos correctamente.');
      return;
    }

    try {
      const res = await fetch(`${apiBase}/produtos`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ name, description, price, image })
      });

      if (!res.ok) {
        const errorData = await res.json().catch(() => ({ message: 'Erro desconhecido ao adicionar produto.' }));
        throw new Error(errorData.message || `Erro HTTP: ${res.status}`);
      }
      
      // alert('Produto adicionado com sucesso!'); // Opcional
      document.getElementById('formAddProduto').reset();
      carregarProdutos(); // Recarrega a lista
    } catch (error) {
      console.error('Erro ao adicionar produto:', error);
      alert(`Erro ao adicionar produto: ${error.message}`);
      if (error.message.includes("Token inválido") || error.message.includes("Token não fornecido")) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
      }
    }
  });

  // Carregar mensagens de contato (requer token)
  async function carregarContatos() {
    if (!token) { // Garante que há token
        // Não é crítico se as mensagens não carregarem, mas idealmente o admin está logado
        console.warn('Token de admin não encontrado para carregar contatos.');
        document.getElementById('contatosLista').innerHTML = '<p>Faça login como administrador para ver as mensagens.</p>';
        return;
    }
    try {
      const res = await fetch(`${apiBase}/contatos`, { // Assumindo que GET /contatos é protegido
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) {
         const errorData = await res.json().catch(() => ({ message: 'Erro desconhecido ao carregar mensagens.' }));
         throw new Error(errorData.message || `Erro HTTP: ${res.status}`);
      }

      const contatos = await res.json();
      const container = document.getElementById('contatosLista');
      container.innerHTML = '';

      if(contatos.length === 0){
        container.innerHTML = '<p>Nenhuma mensagem recebida.</p>';
        return;
      }

      contatos.forEach(c => {
        const div = document.createElement('div');
        div.className = 'contact-item';
        div.innerHTML = `
          <strong>${c.nome || 'Anônimo'}</strong> (${c.email || 'Sem email'})<br/>
          <p style="white-space: pre-wrap;">${c.mensagem || 'Sem mensagem.'}</p>
          <em>Enviado em: ${c.data ? new Date(c.data).toLocaleString() : 'Data desconhecida'}</em>
        `; // Removido <hr/> para consistência com .product-item
        container.appendChild(div);
      });
    } catch (error) {
      console.error('Erro ao carregar mensagens:', error);
      alert(`Erro ao carregar mensagens: ${error.message}. Faça login novamente se o problema persistir.`);
      // Se o erro for de token, redireciona para o login
      if (error.message.includes("Token inválido") || error.message.includes("Token não fornecido")) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
      } else {
          document.getElementById('contatosLista').innerHTML = `<p style="color:red;">Erro ao carregar mensagens. Tente novamente.</p>`;
      }
    }
  }

  // Carregar dados ao iniciar a página
  window.onload = () => {
    if (token) { // Só carrega se houver token de admin
        carregarProdutos();
        carregarContatos();
    } else {
        // Se não há token, a verificação no topo já deve ter redirecionado.
        // Mas, por segurança, podemos exibir mensagens indicando a necessidade de login.
        document.getElementById('produtosLista').innerHTML = '<p>Faça login como administrador para gerenciar produtos.</p>';
        document.getElementById('contatosLista').innerHTML = '<p>Faça login como administrador para ver as mensagens.</p>';
        document.getElementById('formAddProduto').style.display = 'none'; // Esconde o formulário de adicionar
    }
  };
</script>
</body>
</html>